# 🐛 认证模块调试指南

## 📋 **调试日志说明**

我们在三层防护机制的关键位置添加了轻量级调试日志，帮助您确认认证流程是否正常工作。

---

## 📝 **日志输出示例**

### 🚀 **App启动时（第一层）**

当您启动App时，会看到如下日志：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 [第一层] App启动 - 开始认证初始化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📡 步骤1/3: 连接API客户端...
   ✅ API客户端已连接到AuthStore

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔌 [第三层] API拦截器 - 已连接AuthStore
   功能: 自动添加token + 401自动刷新
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔐 步骤2/3: 初始化认证状态...
   ✅ 认证状态已初始化
   📊 登录状态: ❌ 未登录    // 或 ✅ 已登录

✨ 步骤3/3: 完成初始化

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎉 [第一层] 认证初始化完成！
   状态: isAuthenticated=false
   耗时: ~500ms
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 🛡️ **Tab切换时（第二层）**

当Tab布局加载时：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️ [第二层] 路由守卫 - Tab布局加载
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   📊 认证状态: ❌ 未登录 (访客模式)
   🌐 白名单Tab: homepage, discover
   🔒 受保护Tab: messages, profile
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

点击**白名单Tab**（首页、发现）时：

```
🌐 [第二层] 访问首页Tab - 白名单路由，✅ 允许访问
```

点击**受保护Tab**（消息、我的）时（未登录）：

```
🚫 [第二层] 路由守卫拦截！
   Tab: 消息
   状态: 受保护路由
   原因: 用户未登录
   操作: ❌ 阻止访问
```

点击**受保护Tab**（已登录）时：

```
🔒 [第二层] 访问消息Tab - 受保护路由，✅ 已登录，允许访问
```

### 🌐 **API请求时（第三层）**

当发起API请求时：

```
🔑 [第三层] API请求拦截 - 已自动添加token
   请求: GET /api/users
   Token: mock_token_17278932...
```

如果是匿名请求：

```
📡 [第三层] API请求 - 无token（匿名请求）
   请求: GET /api/public/banners
```

### 🔄 **Token过期自动刷新**

当API返回401错误时：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [第三层] 检测到401错误 - 尝试刷新token
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   原请求: /api/users
   步骤1: 调用authStore.refreshToken()
   ✅ Token刷新成功
   新Token: mock_token_17278955...
   步骤2: 重新发送原请求
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

如果刷新失败：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ [第三层] Token刷新失败
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   原因: Invalid refresh token
   操作: 清除认证数据，需要重新登录
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 🔑 **用户登录时**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔑 用户登录流程开始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   手机号: 13800138000
   登录方式: 密码登录
   步骤1: 保存token到SecureStore
   步骤2: 更新认证状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 登录成功！
   用户: 测试用户
   Token: mock_token_17278932...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 👋 **用户登出时**

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
👋 用户登出流程开始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   步骤1: 删除SecureStore中的token
   步骤2: 重置认证状态
   📊 当前状态: isAuthenticated = false
✅ 登出成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🧪 **全局调试工具**

在开发环境下，我们提供了全局调试工具，可以在Chrome开发者工具控制台中直接使用。

### 📊 **查看当前状态**

```javascript
// 在Chrome DevTools控制台输入：
authDebug.status()

// 输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 当前认证状态摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   isAuthenticated: ✅ 是
   isInitialized: ✅ 是
   hasToken: ✅ 有
   userInfo: 测试用户
   loginMode: password
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 🔑 **快速测试登录**

```javascript
// 测试登录
authDebug.testLogin()

// 或指定手机号
authDebug.testLogin('13900139000')
```

### 👋 **快速测试登出**

```javascript
authDebug.testLogout()
```

### 🔍 **测试白名单配置**

```javascript
authDebug.testWhitelist()

// 输出：
🧪 [测试] 白名单配置检查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ /(tabs)/homepage
✅ /(tabs)/discover
🔒 /(tabs)/messages
🔒 /(tabs)/profile
✅ /auth/login
🔒 /publish
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 🛡️ **查看三层防护状态**

```javascript
authDebug.showProtection()

// 输出：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🛡️ 三层防护机制状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   第一层: ✅ App启动时初始化（已激活）
   第二层: ✅ 路由守卫（已激活）
   第三层: ✅ API拦截器（已激活）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔍 **如何查看日志**

### 📱 **Android设备**

```bash
# 方法1：使用React Native CLI
npx react-native log-android

# 方法2：使用adb
adb logcat *:S ReactNative:V ReactNativeJS:V

# 方法3：在Expo Dev Tools中查看
# 启动后访问 http://localhost:8081
# 点击"Logs"标签页
```

### 📱 **iOS设备**

```bash
# 使用React Native CLI
npx react-native log-ios

# 或在Xcode中查看Console
```

### 🌐 **Web版（Chrome DevTools）**

```bash
# 1. 启动Web版
npm run web

# 2. 打开Chrome DevTools (F12)
# 3. 切换到Console标签
# 4. 查看彩色格式化的日志
# 5. 可以直接使用 authDebug.*调试工具
```

---

## 🎯 **完整测试流程**

### 🧪 **测试场景1：未登录用户首次打开App**

**操作步骤**：
1. 清除App数据（模拟首次安装）
2. 启动App
3. 观察日志输出

**预期日志**：
```
🚀 [第一层] App启动 - 开始认证初始化
   📊 登录状态: ❌ 未登录
🎉 [第一层] 认证初始化完成！

🛡️ [第二层] 路由守卫 - Tab布局加载
   📊 认证状态: ❌ 未登录 (访客模式)
```

**测试操作**：
- 点击首页 → 看到：`🌐 [第二层] 访问首页Tab - 白名单路由，✅ 允许访问`
- 点击发现 → 看到：`🌐 [第二层] 访问发现Tab - 白名单路由，✅ 允许访问`
- 点击消息 → 看到：`🚫 [第二层] 路由守卫拦截！`
- 点击我的 → 看到：`🚫 [第二层] 路由守卫拦截！`

### 🧪 **测试场景2：测试登录流程**

**在Chrome DevTools控制台输入**：
```javascript
authDebug.testLogin()
```

**预期日志**：
```
🧪 [测试] 执行快速登录测试...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔑 用户登录流程开始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   手机号: 13800138000
   登录方式: 密码登录
   步骤1: 保存token到SecureStore
   步骤2: 更新认证状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 登录成功！
   用户: 测试用户
   Token: mock_token_...
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 当前认证状态摘要
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   isAuthenticated: ✅ 是
   hasToken: ✅ 有
   userInfo: 测试用户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**测试操作**：
- 登录后点击消息Tab → 看到：`🔒 [第二层] 访问消息Tab - 受保护路由，✅ 已登录，允许访问`
- 登录后点击我的Tab → 看到：`🔒 [第二层] 访问我的Tab - 受保护路由，✅ 已登录，允许访问`

### 🧪 **测试场景3：测试API请求**

**在任何页面发起API请求**：
```typescript
import { userApi } from '@/services/api';

// 发起请求
const response = await userApi.getUserList();
```

**预期日志**：
```
🔑 [第三层] API请求拦截 - 已自动添加token
   请求: GET /api/users
   Token: mock_token_1727893200000...
```

### 🧪 **测试场景4：测试登出**

**在控制台输入**：
```javascript
authDebug.testLogout()
```

**预期日志**：
```
🧪 [测试] 执行快速登出测试...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
👋 用户登出流程开始
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   步骤1: 删除SecureStore中的token
   步骤2: 重置认证状态
   📊 当前状态: isAuthenticated = false
✅ 登出成功
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 🔧 **可用的调试命令**

### 📊 **基础命令**

```javascript
// 查看当前认证状态
authDebug.status()

// 查看三层防护状态
authDebug.showProtection()

// 测试白名单配置
authDebug.testWhitelist()
```

### 🔑 **认证操作**

```javascript
// 快速登录
authDebug.testLogin()
authDebug.testLogin('13900139000')  // 指定手机号

// 快速登出
authDebug.testLogout()
```

### 🔍 **高级调试**

```javascript
// 直接访问authStore
import { useAuthStore } from '@/src/features/AuthModule';

// 查看完整状态
console.log(useAuthStore.getState());

// 手动设置状态
useAuthStore.getState().setLoginMode('sms');

// 手动清除认证
useAuthStore.getState().clearAuthData();
```

---

## 📋 **日志检查清单**

### ✅ **启动时应该看到**

- [ ] `🚀 [第一层] App启动 - 开始认证初始化`
- [ ] `📡 步骤1/3: 连接API客户端...`
- [ ] `🔌 [第三层] API拦截器 - 已连接AuthStore`
- [ ] `🔐 步骤2/3: 初始化认证状态...`
- [ ] `📊 登录状态: ❌ 未登录` 或 `✅ 已登录`
- [ ] `🎉 [第一层] 认证初始化完成！`
- [ ] `🛡️ [第二层] 路由守卫 - Tab布局加载`

### ✅ **点击Tab时应该看到**

- [ ] 首页：`🌐 [第二层] 访问首页Tab - 白名单路由，✅ 允许访问`
- [ ] 发现：`🌐 [第二层] 访问发现Tab - 白名单路由，✅ 允许访问`
- [ ] 消息（未登录）：`🚫 [第二层] 路由守卫拦截！`
- [ ] 我的（未登录）：`🚫 [第二层] 路由守卫拦截！`
- [ ] 消息（已登录）：`🔒 [第二层] 访问消息Tab - ✅ 已登录，允许访问`

### ✅ **登录/登出时应该看到**

- [ ] 登录开始：`🔑 用户登录流程开始`
- [ ] 登录成功：`✅ 登录成功！`
- [ ] 登出开始：`👋 用户登出流程开始`
- [ ] 登出成功：`✅ 登出成功`

---

## 🎯 **常见日志分析**

### ❓ **日志：`❌ 未登录 (访客模式)`**

**含义**：当前用户未登录，处于访客模式

**可以做的事**：
- ✅ 浏览首页和发现Tab
- ✅ 查看公开内容
- ❌ 不能访问消息和我的Tab
- ❌ 不能执行互动操作（点赞、评论等）

### ❓ **日志：`🚫 [第二层] 路由守卫拦截！`**

**含义**：用户尝试访问受保护的路由，但未登录

**解决方法**：
1. 引导用户登录
2. 或在控制台使用 `authDebug.testLogin()` 快速登录

### ❓ **日志：`📡 [第三层] API请求 - 无token（匿名请求）`**

**含义**：发起了不需要认证的API请求

**正常情况**：
- 获取公开数据（横幅、公告等）
- 某些不需要登录的功能

**异常情况**：
- 如果是需要认证的接口但显示无token，说明认证状态有问题

---

## 🎨 **日志样式说明**

### 图标含义

- 🚀 App启动
- 🔐 认证相关
- 🛡️ 路由守卫
- 🌐 白名单路由
- 🔒 受保护路由
- 🚫 拦截/阻止
- ✅ 成功/允许
- ❌ 失败/拒绝
- 🔑 Token相关
- 🔄 刷新操作
- 📡 API请求
- 👋 登出操作
- 📊 状态信息
- 🧪 测试操作

---

## 🚀 **快速排查指南**

### 🔍 **问题：App启动后没有看到初始化日志**

**排查步骤**：
1. 确认Metro服务器正在运行
2. 检查日志输出位置（终端或Chrome DevTools）
3. 确认`__DEV__`环境变量为true

### 🔍 **问题：点击受保护Tab没有被拦截**

**排查步骤**：
1. 在控制台输入`authDebug.status()`查看认证状态
2. 检查是否已经登录（isAuthenticated = true）
3. 查看白名单配置：`authDebug.testWhitelist()`

### 🔍 **问题：API请求没有自动添加token**

**排查步骤**：
1. 检查是否看到`🔌 [第三层] API拦截器 - 已连接AuthStore`
2. 确认用户已登录：`authDebug.status()`
3. 查看请求日志中是否显示token

---

## 💡 **调试技巧**

### 🎯 **技巧1：完整日志流程追踪**

```bash
# 1. 启动App
npm start

# 2. 在新终端查看日志
npx react-native log-android  # Android
npx react-native log-ios      # iOS

# 3. 观察完整流程：
#    启动 → 初始化 → Tab加载 → 用户操作
```

### 🎯 **技巧2：使用Chrome远程调试**

```bash
# 1. 摇晃设备或按 Cmd+D / Ctrl+D
# 2. 选择"Debug with Chrome"
# 3. 在Chrome DevTools Console中使用 authDebug.*
```

### 🎯 **技巧3：添加自定义日志**

```typescript
// 在任何组件中
import { authDebugLogger } from '@/src/features/AuthModule/utils/debugLogger';

// 记录路由访问
authDebugLogger.logRouteAccess(
  '/(tabs)/homepage',
  true,
  '白名单路由'
);

// 记录状态变化
authDebugLogger.logAuthStateChange(false, true);
```

---

## 📊 **日志级别说明**

我们的日志非常轻量，只在关键节点输出：

| 日志类型 | 频率 | 位置 |
|---------|------|------|
| **App启动** | 1次 | App启动时 |
| **Tab加载** | 1次 | Tab布局加载时 |
| **Tab切换** | 每次点击 | Tab点击时 |
| **登录/登出** | 按需 | 用户操作时 |
| **API请求** | 每次请求 | API调用时 |
| **401处理** | 仅错误时 | Token过期时 |

**总体评估**：📊 **轻量级** - 不会影响性能，方便调试

---

## 🎊 **使用建议**

### ✅ **开发阶段**
- 保持调试日志开启
- 使用`authDebug.*`快速测试
- 观察每次操作的日志输出

### ✅ **测试阶段**
- 验证三层防护是否正常工作
- 确认白名单配置是否正确
- 测试各种边界场景

### ✅ **生产环境**
- 调试日志会自动关闭（通过`__DEV__`控制）
- 只保留必要的错误日志
- 不影响性能

---

**💡 提示**：所有调试日志只在开发环境显示，生产环境会自动关闭，无需手动移除！

**🎯 快速开始**：启动App后，在Chrome DevTools中输入 `authDebug.status()` 查看当前状态！
